<?xml version="1.0"?>
<!DOCTYPE bindings [
<!ENTITY % panoToolbarDTD SYSTEM "chrome://pano-toolbar/locale/toolbar.dtd" >
%panoToolbarDTD;
]>
<bindings id="panoTabGroupBindings"
          xmlns="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
          xmlns:xbl="http://www.mozilla.org/xbl">
  <binding id="tabgroup-tabs"
           extends="chrome://global/content/bindings/tabbox.xml#tabs">
    <resources>
      <stylesheet src="chrome://browser/content/tabbrowser.css"/>
    </resources>

    <content>
      <xul:hbox align="end">
        <xul:image class="tab-drop-indicator" anonid="tab-drop-indicator" collapsed="true"/>
      </xul:hbox>
      <xul:arrowscrollbox anonid="arrowscrollbox" orient="horizontal" flex="1"
                          style="min-width: 1px;"
                          clicktoscroll="true"
                          class="tabgroup-arrowscrollbox">
        <children includes="tab"/>
        <children/>
        <xul:toolbarbutton class="tabs-newtab-button"
                           oncommand="this.parentNode.parentNode.newGroup();"
                           tooltiptext="&newGroup.tooltip;"/>
        <xul:spacer class="closing-tabs-spacer" anonid="closing-tabs-spacer"
                    style="width: 0;"/>
      </xul:arrowscrollbox>
    </content>
    <implementation implements="nsIDOMEventListener">
      <constructor><![CDATA[
        this.rebuild();

        for (let [, type] in Iterator(["tabviewhidden","TabGroupAdded","TabGroupClose","TabSelect","TabGroupTitleChanged"])) {
          window.addEventListener(type, this, false);
        }
      ]]></constructor>

      <destructor><![CDATA[
        for (let [, type] in Iterator(["tabviewhidden","TabGroupAdded","TabGroupClose","TabSelect","TabGroupTitleChanged"])) {
          window.removeEventListener(type, this, false);
        }
      ]]></destructor>

      <field name="mScrollBox">
        document.getAnonymousElementByAttribute(this, "anonid", "arrowscrollbox");
      </field>

      <field name="mSessionStore">
        Cc["@mozilla.org/browser/sessionstore;1"].getService(Ci.nsISessionStore);
      </field>

      <property name="selectedIndex">
        <getter><![CDATA[
          const tabs = this.childNodes;
          for (var i = 0; i < tabs.length; i++) {
            if (tabs[i].selected)
              return i;
          }
          return -1;
        ]]></getter>
        <setter><![CDATA[
          var tab = this.getItemAtIndex(val);
          if (tab) {
            var alreadySelected = tab.selected;

            Array.forEach(this.childNodes, function (aTab) {
              if (aTab.selected && aTab != tab)
                aTab._selected = false;
            });
            tab._selected = true;

            this.setAttribute("value", tab.value);

            this.mScrollBox.ensureElementIsVisible(tab);

            if (!alreadySelected) {
              this.selectBrowserTab(tab.value);
              // Fire an onselect event for the tabs element.
              var event = document.createEvent('Events');
              event.initEvent('select', true, true);
              this.dispatchEvent(event);
            }
          }
          return val;
        ]]></setter>
      </property>
      <method name="selectBrowserTab">
        <parameter name="groupId"/>
        <body><![CDATA[
          if (!groupId)
            return;

          TabView._initFrame(function() {
            var win = TabView._window;
            var group = win.GroupItems.groupItem(groupId);
            if (win.GroupItems._activeGroupItem != group) {
              win.UI.setActive(group, { dontSetActiveTabInGroup: true });
              let selectedTab = gBrowser.selectedTab;
              if (!selectedTab.pinned) {
                let item = group.getActiveTab() || group._children[0];
                gBrowser.mTabContainer.selectedIndex = item.tab._tPos;
              } else {
                win.UI.onTabSelect(selectedTab);
              }
            }
          });
        ]]></body>
      </method>
      <method name="rebuild">
        <body><![CDATA[
          if ("__SSi" in window) {
            let groupData = [data for ([, data] in Iterator(JSON.parse(this.mSessionStore.getWindowValue(window, "tabview-group"))))];
            let groupsData = JSON.parse(this.mSessionStore.getWindowValue(window, "tabview-groups"));

            while (this.childNodes.length > 1) {
              this.removeChild(this.lastChild);
            }

            this.setGroup(this.childNodes[0], groupData[0]);
            if (groupData[0].id == groupsData.activeGroupId)
              this.selectedIndex = 0;

            for (let i = 1, len = groupData.length; i < len; ++i) {
              this.addGroup(groupData[i]);
              if (groupData[i].id == groupsData.activeGroupId)
                this.selectedIndex = i;
            }
            this.mScrollBox.ensureElementIsVisible(this.selectedItem);
          } else {
            let self = this;
            var OBS = {
              observe: function (aSubject, aTopic, aData) {
                Services.obs.removeObserver(this, "sessionstore-windows-restored");
                if (aTopic === "sessionstore-windows-restored") {
                  self.rebuild();
                }
              },
              QueryInterface: XPCOMUtils.generateQI(["nsIObserver","nsISupportsWeakReference"]),
            };
            Services.obs.addObserver(OBS, "sessionstore-windows-restored", true);
          }
        ]]></body>
      </method>
      <method name="setGroup">
        <parameter name="aTab"/>
        <parameter name="aGroup"/>
        <body><![CDATA[
          var title = typeof aGroup.getTitle === "function" ? aGroup.getTitle() : aGroup.title,
              id = aGroup.id;
          aTab.setAttribute("label", title || "- " + id + " -");
          aTab.setAttribute("value", id);
          aTab.setAttribute("crop", "end");
        ]]></body>
      </method>
      <method name="addGroup">
        <parameter name="group"/>
        <body><![CDATA[
          if (!group || this.getItemFromGroupId(group.id))
            return;

          var tab = document.createElementNS("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul", "tab");
          this.setGroup(tab, group);
          tab.setAttribute("class", "pano-tabgroup-tab");
          return this.appendChild(tab);
        ]]></body>
      </method>
      <method name="newGroup">
        <body><![CDATA[
          var self = this;
          TabView._initFrame(function(){
            var group = TabView._window.GroupItems.newGroup();
            var tab = self.addGroup(group);
            group.newTab();
            self.selectedItem = tab;
          });
        ]]></body>
      </method>
      <method name="removeTab">
        <parameter name="id"/>
        <body><![CDATA[
          if (!id)
            return;

          var tab = this.getItemFromGroupId(id);
          if(!tab)
            return;

          if (tab.selected) {
            let nextTab = tab.nextElementSibling || tab.previousElementSibling;
            if (nextTab)
              this.selectedItem = nextTab;
          }
          if (this.childNodes.length > 1)
            this.removeChild(tab);
          else
            this.selectedIndex = 0;

          this.closeGroup(id);
        ]]></body>
      </method>
      <method name="closeGroup">
        <parameter name="id"/>
        <body><![CDATA[
          TabView._initFrame(function(){
            var GI = TabView._window.GroupItems;
            var group = GI.groupItem(id);
            group.closeHidden();
          });
        ]]></body>
      </method>
      <method name="getItemFromGroupId">
        <parameter name="aGroupId"/>
        <body><![CDATA[
          for (let i = 0, len = this.childNodes.length; i < len; ++i) {
            if (this.childNodes[i].value == aGroupId)
              return this.childNodes[i];
          }
          return null;
        ]]></body>
      </method>
      <method name="handleEvent">
        <parameter name="aEvent"/>
        <body><![CDATA[
          switch (aEvent.type) {
            case "tabviewhidden":
              this.onTabViewHidden(aEvent);
              break;
            case "TabGroupAdded":
              this.onTabGroupAdded(aEvent);
              break;
            case "TabGroupClose":
              this.onTabGroupClose(aEvent);
              break;
            case "TabSelect":
              this.onTabSelect(aEvent);
              break;
            case "TabGroupTitleChanged":
              this.onTabGroupTitleChanged(aEvent);
              break;
          }
        ]]></body>
      </method>
      <method name="onTabViewHidden">
        <parameter name="aEvent"/>
        <body><![CDATA[
          this.rebuild();
        ]]></body>
      </method>
      <method name="onTabGroupAdded">
        <parameter name="aEvent"/>
        <body><![CDATA[
          var groupItems = TabView._window.GroupItems.groupItems,
              group = groupItems[groupItems.length - 1];
          this.addGroup(group);
        ]]></body>
      </method>
      <method name="onTabGroupClose">
        <parameter name="aEvent"/>
        <body><![CDATA[
          var groupId = aEvent.detail;
          this.removeTab(groupId);
        ]]></body>
      </method>
      <method name="onTabSelect">
        <parameter name="aEvent"/>
        <body><![CDATA[
          var tab = aEvent.target;
          if (tab.pinned) {
            return;
          }
          if (!tab._tabViewTabItem)
            return;

          var group = tab._tabViewTabItem.parent;
          var item = this.getItemFromGroupId(group.id);
          if (item) {
            this.selectedItem = item;
          }
        ]]></body>
      </method>
      <method name="onTabGroupTitleChanged">
        <parameter name="aEvent"/>
        <body><![CDATA[
          var id = aEvent.detail;
          var item = this.getItemFromGroupId(id),
              group = TabView._window.GroupItems.groupItem(id);
          if (item && group) {
            item.label = group.getTitle() || "- " + id + " -";
          }
        ]]></body>
      </method>
    </implementation>
  </binding>

  <binding id="tabgroup-tab" display="xul:hbox"
           extends="chrome://global/content/bindings/tabbox.xml#tab">
    <content>
      <xul:stack class="tab-stack" flex="1">
        <xul:hbox xbl:inherits="selected" class="tab-background">
          <xul:hbox xbl:inherits="selected" class="tab-background-start"/>
          <xul:hbox xbl:inherits="selected" class="tab-background-middle"/>
          <xul:hbox xbl:inherits="selected" class="tab-background-end"/>
        </xul:hbox>
        <xul:hbox class="tab-content" xbl:inherits="align,dir,pack,orient,selected" flex="1">
          <xul:image class="tab-icon-image"
                     xbl:inherits="validate,src=image"
                     role="presentation"/>
          <xul:deck anonid="title-deck" selectedIndex="1" flex="1">
            <xul:textbox flex="1" anonid="title-textbox" class="tabgroup-title-textbox"/>
            <xul:label xbl:inherits="value=label,accesskey,crop,disabled"
                       flex="1"
                       role="presentation"/>
          </xul:deck>
          <xul:toolbarbutton anonid="close-button"
                             xbl:inherits="selected,value"
                             oncommand="this.parentNode.parentNode.parentNode.close(event);"
                             clickthrough="never"
                             class="tabgroup-closebutton"/>
        </xul:hbox>
      </xul:stack>
    </content>
    <implementation>
      <field name="mOverCloseButton">false</field>
      <field name="mDeck">
        document.getAnonymousElementByAttribute(this, "anonid", "title-deck")
      </field>
      <field name="mTextbox">
        document.getAnonymousElementByAttribute(this, "anonid", "title-textbox")
      </field>
      <method name="close">
        <parameter name="aEvent"/>
        <body><![CDATA[
          aEvent.stopPropagation();
          this.parentNode.removeTab(this.value);
        ]]></body>
      </method>
      <method name="editGroupTitle">
        <body><![CDATA[
          this.mDeck.selectedIndex = 0;
          this.mTextbox.value = this.label;
          this.mTextbox.focus();
        ]]></body>
      </method>
    </implementation>
    <handlers>
      <handler event="mouseover">
        var anonid = event.originalTarget.getAttribute("anonid");
        if (anonid == "close-button")
          this.mOverCloseButton = true;
      </handler>
      <handler event="mouseout">
        var anonid = event.originalTarget.getAttribute("anonid");
        if (anonid == "close-button")
          this.mOverCloseButton = false;
      </handler>
      <handler event="dragstart" phase="capturing">
        this.style.MozUserFocus = '';
      </handler>
      <handler event="mousedown" phase="capturing">
      <![CDATA[
        if (this.selected) {
          this.style.MozUserFocus = 'ignore';
          this.clientTop; // just using this to flush style updates
        } else if (this.mOverCloseButton) {
          // Prevent tabbox.xml from selecting the tab.
          event.stopPropagation();
        }
      ]]>
      </handler>
      <handler event="mouseup">
        this.style.MozUserFocus = '';
      </handler>
      <handler event="dblclick" button="0"><![CDATA[
        this.editGroupTitle();
      ]]></handler>
      <handler event="keypress"><![CDATA[
        if (this.mDeck.selectedIndex == 1)
          return;

        switch (event.keyCode) {
          case KeyEvent.DOM_VK_ENTER:
          case KeyEvent.DOM_VK_RETURN:
          case KeyEvent.DOM_VK_ESCAPE:
            this.mTextbox.blur();
            this.mDeck.selectedIndex = 1;
            let label = this.mTextbox.value;
            this.label = label;
            TabView._window.GroupItems.groupItem(this.value).setTitle(label);
        }
      ]]></handler>
    </handlers>
  </binding>
  <binding id="tabgroup-arrowscrollbox" extends="chrome://global/content/bindings/scrollbox.xml#arrowscrollbox-clicktoscroll">
    <handlers>
      <handler event="underflow" phase="capturing"><![CDATA[
        if (event.detail == 0)
          return; // Ignore vertical events

        var tabs = document.getBindingParent(this);
        tabs.removeAttribute("overflow");
      ]]></handler>
      <handler event="overflow"><![CDATA[
        if (event.detail == 0)
          return; // Ignore vertical events

        var tabs = document.getBindingParent(this);
        tabs.setAttribute("overflow", "true");
      ]]></handler>
    </handlers>
  </binding>
</bindings>

